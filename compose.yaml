services:

  # *********************************************************************************
  # wikijs
  #   Wiki.js is a modern, powerful, and extensible wiki platform built on Node.js.
  #   It allows collaborative documentation, supports Markdown and rich text editing, 
  #   and integrates with various authentication methods and databases. Wiki.js 
  #   can run behind a reverse proxy for secure access, supports SSL/TLS, and is 
  #   highly customizable with themes, modules, and integrations. Typically, it uses
  #   a dedicated database service (PostgreSQL) and exposes a web port for user access.
  #
  # *********************************************************************************
  wikijs:
    image: ghcr.io/requarks/wiki:${TAG_WIKIJS:-latest}
    container_name: wikijs
    restart: unless-stopped
    depends_on:
      - postgres
    ports:
      - "${WIKIJS_EXTERNAL_PORT}:3000"
    environment:
      - TZ=${TZ_ID:-America/New_York}
      - DB_TYPE=postgres
      - DB_HOST=postgres-wikijs
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER}
      - DB_PASS=${POSTGRES_PASSWORD}
      - DB_NAME=${POSTGRES_DATABASE}
    volumes:
      - content:/wiki/data/content
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -------------
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/requarks/wiki/releases'
      # Offen Backup Labels ---------------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *********************************************************************************
  # postgres
  #   PostgreSQL is a robust, open-source relational database system. For Wiki.js, 
  #   it stores all the wiki content, user data, and configuration. PostgreSQL 
  #   provides reliability, data integrity, and performance for concurrent access. 
  #   When used with Wiki.js, it typically requires a dedicated database, user, 
  #   and password, which Wiki.js will use to connect. Volumes are recommended to 
  #   persist data across container restarts or upgrades.
  #
  # *********************************************************************************
  postgres:
    image: postgres:${TAG_POSTGRES:-latest}
    container_name: postgres-wikijs
    environment:
      - TZ=${TZ_ID:-America/New_York}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${POSTGRES_DATABASE}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    restart: always
    volumes:
      - postgres:/var/lib/postgresql/data
    # -------------------------------------------------------------------------------
    # Uncomment this section to expose mysql to connections outside of the container
    # such as MySQL Workbench
    # -------------------------------------------------------------------------------
    # ports:
    #  - ${POSTGRES_EXTERNAL_PORT}:5432

    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -------------
      - 'wud.tag.include=^17(\.\d+)*$$' # Show all version 17 updates
      # - 'wud.tag.include=^\d+\.\d+$$' # Show all version updates
      - 'wud.link.template=https://www.postgresql.org/docs/release/'
      # Offen Backup Labels ---------------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *********************************************************************************
  # docker-volume-backup
  #   Automated daily backup of Docker named volumes using offen/docker-volume-backup.
  #   This lightweight service runs in the background, creates a single compressed 
  #   archive containing all specified volumes, and automatically prunes old backups 
  #   based on the configured retention period. It ensures data consistency by 
  #   temporarily stopping labeled containers during the backup process. Backups 
  #   are stored locally on the host; a separate secure process (e.g., rsync/cron) 
  #   can be used for off-site transfer.
  #
  # *********************************************************************************
  volume-backup:
    image: offen/docker-volume-backup:${TAG_OFFEN:-latest}
    container_name: ${BACKUP_LABEL}-backup
    restart: unless-stopped
    depends_on:
      - wikijs
      - postgres
    environment:
      - BACKUP_CRON_EXPRESSION=${BACKUP_CRON_EXPRESSION:-0 2 * * *}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-14}
      - BACKUP_FILENAME=${BACKUP_LABEL}-%Y-%m-%dT%H-%M-%S.tar.gz
      - BACKUP_STOP_DURING_BACKUP_LABEL=${BACKUP_LABEL}
      - NOTIFICATION_LEVEL=${BACKUP_NOTIFICATION_LEVEL:-error}
      - NOTIFICATION_URLS=${BACKUP_NOTIFICATION_URLS}          # Comma-separated list of URLs      
    volumes:
      # Volumes to backup
      - content:/backup/content:ro                     
      - postgres:/backup/postgres:ro                   
      # Local backup location - use a separate secure transfer process to move backups to another host
      - ${BACKUP_LOCAL_TMP_PATH}:/tmp  # Assign a specific tmp dir on the host.  Comment this out to use /tmp
      - ${BACKUP_LOCAL_PATH}:/archive                     
      # Time synch with host to ensure accurate CRON scheduling
      - /etc/localtime:/etc/localtime:ro               
      - /etc/timezone:/etc/timezone:ro                 
      # Allows backup container to control other containers
      - /var/run/docker.sock:/var/run/docker.sock:ro   

    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -------------
      # Support leading 'V'
      - 'wud.tag.include=^v\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/offen/docker-volume-backup/releases'      

volumes:
  content:
  postgres: